# LED 제어 로직 상세 분석

**작성일**: 2026-01-03  
**최종 업데이트**: 2026-01-03

---

## 📋 LED 제어 개요

스마트팜 시스템의 LED 조명은 **일조량(DLI) 기반 자동 제어**로 작동합니다. 자연광이 부족하거나 일조량 목표를 달성하기 어려울 때 자동으로 보조 조명을 제공합니다.

---

## ⚙️ 현재 설정값 (config.py)

```python
LED_ON_HOUR = 8           # 08:00 (참고용, 실제는 6시부터 작동 가능)
LED_OFF_HOUR = 20         # 20:00
TARGET_DLI_MIN = 12.0     # 최소 일조량 목표 (mol/m²/day)
TARGET_DLI_MAX = 17.0     # 최대 일조량 목표 (mol/m²/day)
MIN_LUX_THRESHOLD = 500   # 자연광 부족 기준 (Lux)
LED_PURPLE_BOOST = True   # 보라색 LED 보조 사용
```

---

## 🔄 LED 작동 시간대

### 실제 작동 가능 시간
- **시작**: 오전 6시 (광합성 활성 시작)
- **종료**: 오후 8시 (광합성 활성 종료)
- **총 시간**: 14시간

> **참고**: `LED_ON_HOUR = 8`은 참고용 설정이며, 실제로는 6시부터 LED가 작동할 수 있습니다.

---

## 💡 LED 작동 조건 (우선순위 순)

### 1순위: 자연광 즉시 부족
**조건**: `현재 조도 < 500 Lux`

**동작**: 즉시 LED 켜기

**이유**: 자연광이 거의 없으면 식물 광합성이 불가능하므로 즉시 보조 필요

**예시**:
- 겨울 아침 6시: 200 Lux → LED 켜짐 ✅
- 여름 정오 12시: 2000 Lux → LED 꺼짐 ❌

---

### 2순위: 시간대별 DLI 부족
**조건**: `현재 DLI < 시간대별 목표 DLI의 70%`

**시간대별 목표 DLI 계산**:
```
시간대별 목표 = TARGET_DLI_MIN × (경과 시간 / 총 활성 시간)
```

**예시**:
- 오전 8시: 목표의 약 14% (1.7 mol/m²/day)
- 정오 12시: 목표의 약 43% (5.2 mol/m²/day)
- 오후 6시: 목표의 약 86% (10.3 mol/m²/day)

**동작**: LED 켜기

**이유**: 시간대 대비 DLI가 부족하면 하루 종료 시 목표 달성 어려움

**예시**:
- 오전 8시, 현재 DLI 0.5 mol/m²/day, 목표 1.7 mol/m²/day
  - 0.5 < 1.7 × 0.7 (1.19) → LED 켜짐 ✅
- 정오 12시, 현재 DLI 6.0 mol/m²/day, 목표 5.2 mol/m²/day
  - 6.0 >= 5.2 × 0.7 (3.64) → LED 꺼짐 ❌

---

### 3순위: 예상 총 DLI 부족
**조건**: `예상 총 DLI < 목표의 80%`

**예상 총 DLI 계산**:
```
예상 총 DLI = 현재 DLI + (현재 PPFD × 남은 시간)
```

**동작**: LED 켜기

**이유**: 현재 추세로는 하루 종료 시 목표 달성 불가능 예상

**예시**:
- 오후 3시, 현재 DLI 6.0 mol/m²/day, 현재 PPFD 200 μmol/m²/s
- 남은 시간: 5시간
- 예상 추가 DLI: (200 × 5 × 3600) / 1,000,000 = 3.6 mol/m²/day
- 예상 총 DLI: 6.0 + 3.6 = 9.6 mol/m²/day
- 9.6 < 12.0 × 0.8 (9.6) → LED 켜짐 ✅

---

## 🌈 LED 종류별 제어

### 화이트 LED (주 조명)
- **역할**: 일반 조명, 주 광원
- **작동 조건**: 위 3가지 조건 중 하나라도 만족 시 작동
- **밝기**: 100% (최대)
- **페이드**: 10분 동안 서서히 밝아짐/꺼짐 (광충격 방지)

### 보라색 LED (보조 조명)
- **역할**: 식물 생장 최적화 스펙트럼 보완
- **작동 조건**: 
  - 화이트 LED가 켜져 있고
  - `현재 DLI < 목표의 70%` 일 때만 작동
- **밝기**: 100% (최대 밝기 대비)
- **페이드**: 화이트 LED와 동시에 켜기/끄기

---

## 📅 계절별 작동 시나리오

### 겨울 (12월 ~ 2월)

#### 아침 6-8시
- **자연광**: 매우 부족 (100-300 Lux)
- **현재 DLI**: 0.0-0.5 mol/m²/day
- **LED 동작**: ✅ 켜짐
  - 이유: 자연광 부족 (1순위 조건)
  - 화이트 LED: 켜짐
  - 보라색 LED: 켜짐 (DLI 매우 낮음)

#### 오전 9-11시
- **자연광**: 부족 (300-800 Lux)
- **현재 DLI**: 0.5-2.0 mol/m²/day
- **LED 동작**: ✅ 켜짐
  - 이유: 시간대별 DLI 부족 (2순위 조건)
  - 화이트 LED: 켜짐
  - 보라색 LED: 켜짐 (DLI < 목표의 70%)

#### 정오 12-14시
- **자연광**: 보통 (800-1500 Lux)
- **현재 DLI**: 2.0-5.0 mol/m²/day
- **LED 동작**: ⚠️ 상황에 따라
  - 자연광이 500 Lux 이상이면 꺼짐
  - DLI가 시간대별 목표의 70% 이상이면 꺼짐
  - 그 외에는 켜짐

#### 오후 15-17시
- **자연광**: 약함 (400-800 Lux)
- **현재 DLI**: 5.0-8.0 mol/m²/day
- **LED 동작**: ✅ 켜짐
  - 이유: 예상 총 DLI 부족 (3순위 조건)
  - 화이트 LED: 켜짐
  - 보라색 LED: DLI가 목표의 70% 이상이면 꺼짐

#### 저녁 18-20시
- **자연광**: 매우 약함 (100-300 Lux)
- **현재 DLI**: 8.0-10.0 mol/m²/day
- **LED 동작**: ✅ 켜짐
  - 이유: 자연광 부족 + 예상 총 DLI 부족
  - 화이트 LED: 켜짐
  - 보라색 LED: 꺼짐 (DLI가 목표의 70% 이상)

---

### 여름 (6월 ~ 8월)

#### 아침 6-8시
- **자연광**: 보통 (500-1000 Lux)
- **현재 DLI**: 0.5-2.0 mol/m²/day
- **LED 동작**: ⚠️ 상황에 따라
  - 자연광이 500 Lux 이상이면 꺼짐
  - DLI가 시간대별 목표의 70% 미만이면 켜짐

#### 정오 12-14시
- **자연광**: 충분 (2000-5000 Lux)
- **현재 DLI**: 8.0-12.0 mol/m²/day
- **LED 동작**: ❌ 꺼짐
  - 이유: 자연광 충분 + DLI 목표 달성 가능

#### 오후 15-17시
- **자연광**: 충분 (1500-3000 Lux)
- **현재 DLI**: 12.0-15.0 mol/m²/day
- **LED 동작**: ❌ 꺼짐
  - 이유: DLI 목표 달성 완료

---

## 🔍 LED 작동 판단 흐름도

```
[LED 제어 시작]
    ↓
현재 시간이 6시 ~ 20시 사이?
    ↓ YES
자연광 < 500 Lux?
    ↓ YES → LED 켜기 (1순위)
    ↓ NO
현재 DLI < 시간대별 목표의 70%?
    ↓ YES → LED 켜기 (2순위)
    ↓ NO
예상 총 DLI < 목표의 80%?
    ↓ YES → LED 켜기 (3순위)
    ↓ NO
LED 꺼기
```

---

## ⚡ LED 켜기/끄기 로직

### LED 켜기
1. **화이트 LED**: 페이드 인 시작 (10분 동안 서서히 밝아짐)
2. **보라색 LED**: DLI < 목표의 70%일 때만 페이드 인 시작

### LED 끄기
1. **시간대 종료**: 20시 이후 또는 6시 이전
2. **목표 달성**: DLI 목표 달성 완료
3. **화이트 LED**: 페이드 아웃 시작 (10분 동안 서서히 꺼짐)
4. **보라색 LED**: 화이트 LED와 동시에 페이드 아웃

---

## 📊 실제 작동 예시

### 겨울 아침 7시
```
자연광: 250 Lux
현재 DLI: 0.3 mol/m²/day
시간대별 목표: 1.0 mol/m²/day (목표의 약 8%)

판단:
1. 자연광 250 < 500 → ✅ LED 켜기 (1순위)
2. 현재 DLI 0.3 < 1.0 × 0.7 (0.7) → ✅ LED 켜기 (2순위)

결과: 화이트 LED + 보라색 LED 모두 켜짐
```

### 여름 정오 12시
```
자연광: 3000 Lux
현재 DLI: 8.5 mol/m²/day
시간대별 목표: 5.2 mol/m²/day (목표의 약 43%)

판단:
1. 자연광 3000 >= 500 → ❌ LED 꺼기
2. 현재 DLI 8.5 >= 5.2 × 0.7 (3.64) → ❌ LED 꺼기

결과: LED 모두 꺼짐
```

### 겨울 오후 3시
```
자연광: 600 Lux
현재 DLI: 5.0 mol/m²/day
시간대별 목표: 9.0 mol/m²/day (목표의 약 75%)
예상 총 DLI: 9.5 mol/m²/day

판단:
1. 자연광 600 >= 500 → ❌ LED 꺼기
2. 현재 DLI 5.0 < 9.0 × 0.7 (6.3) → ✅ LED 켜기 (2순위)
3. 예상 총 DLI 9.5 < 12.0 × 0.8 (9.6) → ✅ LED 켜기 (3순위)

결과: 화이트 LED 켜짐, 보라색 LED 꺼짐 (DLI >= 목표의 70%)
```

---

## 🎯 핵심 포인트

### 1. 시간대 제한 완화
- **기존**: 8시 ~ 20시만 작동
- **개선**: 6시 ~ 20시 작동 가능
- **효과**: 겨울철 일출 전에도 LED 작동 가능

### 2. 다단계 판단
- 절대값이 아닌 **시간대별 상대값**으로 판단
- 아침에 당연히 낮은 DLI를 경고하지 않음
- 실제 문제 상황만 LED 작동

### 3. 예측 기반 제어
- 현재 추세로 하루 종료 시 목표 달성 가능 여부 예측
- 불필요한 LED 작동 방지
- 에너지 효율성 향상

### 4. 계절 자동 대응
- 겨울: 자연광 부족 → LED 자주 작동
- 여름: 자연광 충분 → LED 거의 작동 안 함
- 수동 설정 변경 불필요

---

## ⚠️ 주의사항

1. **LED 페이드 시간**: 10분 동안 서서히 밝아지므로 즉시 켜지지 않음
2. **DLI 누적**: 자정에 리셋되므로 하루 단위로 관리
3. **자연광 우선**: 자연광이 충분하면 LED는 꺼짐
4. **보라색 LED**: 화이트 LED가 켜져 있을 때만 작동

---

## 📝 요약

### 현재 세팅으로 LED는 언제 켜지나?
1. **자연광이 500 Lux 미만**일 때 (즉시)
2. **시간대별 DLI가 목표의 70% 미만**일 때
3. **예상 총 DLI가 목표의 80% 미만**일 때

### 겨울에는?
- **아침부터 LED 켜짐**: 자연광 부족 + DLI 부족
- **하루 종료까지 LED 유지**: 목표 달성을 위해 지속 작동
- **화이트 + 보라색 LED 동시 작동**: DLI가 매우 낮을 때

### 여름에는?
- **정오에는 LED 꺼짐**: 자연광 충분
- **아침/저녁만 필요시 작동**: 자연광이 약할 때만
- **대부분 LED 꺼짐**: 자연광으로 목표 달성 가능

---

**작성 완료일**: 2026-01-03

