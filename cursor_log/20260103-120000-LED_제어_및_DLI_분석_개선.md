# LED 제어 및 DLI 분석 개선 기록

**작성일**: 2026-01-03  
**작성자**: Cursor AI  
**주제**: 일조량(DLI) 분석 알고리즘 개선 및 LED 제어 로직 최적화

---

## 📋 개선 목표

1. **일조량 부족 경고 개선**: 아침 시간대에 당연히 뜨는 경고 메시지 문제 해결
2. **시간대별 DLI 예측**: 현재 시점에서 하루 종료까지 예상 DLI 계산
3. **LED 제어 로직 개선**: 겨울철 등 자연광 부족 시 LED 작동 시간 확대
4. **직관적인 상태 표시**: 현재 DLI 진행률 및 목표 달성 가능 여부 시각화

---

## 🔵 기존 문제점

### 1. 일조량 부족 경고 문제
- **증상**: 아침 시간대(6-8시)에 "일조량 부족" 경고가 당연히 발생
- **원인**: 절대값 기준(`dli < TARGET_DLI_MIN * 0.5`)으로만 판단
- **문제**: 시간대를 고려하지 않아 아침에는 당연히 낮은 DLI를 경고로 표시

### 2. LED 제어 로직 한계
- **현재 설정**: `LED_ON_HOUR (8시) ~ LED_OFF_HOUR (20시)` 시간대에만 작동
- **문제**: 
  - 겨울철 아침 6-8시에도 자연광이 부족하지만 LED가 켜지지 않음
  - 시간대 제한이 너무 엄격하여 계절 변화에 대응 불가
  - DLI 예측 없이 현재 값만으로 판단

---

## 🟢 개선 사항

### 1. 시간대별 DLI 예측 알고리즘

#### 구현 내용
```python
def calculate_expected_dli_by_time(current_hour, current_dli, current_lux):
    """
    현재 시간대에서 하루 종료까지 예상 DLI 계산
    
    알고리즘:
    1. 광합성 활성 시간대: 6시 ~ 20시 (14시간)
    2. 현재 시간까지 경과한 활성 시간 계산
    3. 시간대별 목표 DLI 비율 계산 (선형 가정)
    4. 현재 PPFD 기반으로 남은 시간 동안 예상 DLI 계산
    5. 예상 총 DLI = 현재 DLI + 예상 추가 DLI
    """
```

#### 시간대별 목표 DLI 비율
- **오전 6시**: 0% (활성 시작)
- **오전 8시**: 약 14% (2시간 경과 / 14시간)
- **정오 12시**: 약 43% (6시간 경과 / 14시간)
- **오후 6시**: 약 86% (12시간 경과 / 14시간)
- **오후 8시**: 100% (활성 종료)

#### 예측 모델
- **오전 (6-12시)**: 현재 PPFD를 기준으로 증가 추세 가정
- **오후 (12-20시)**: 현재 PPFD를 기준으로 감소 추세 가정
- **보수적 추정**: 현재 PPFD의 70%로 남은 시간 평균 추정

### 2. 개선된 일조량 부족 경고

#### 새로운 판단 기준
```python
# 기존: 절대값 기준
if dli < TARGET_DLI_MIN * 0.5:  # 항상 아침에 경고

# 개선: 시간대별 상대값 기준
expected_dli_at_this_time = TARGET_DLI_MIN * (elapsed_hours / total_active_hours)
if dli < expected_dli_at_this_time * 0.7 and not is_on_track:
    # 경고 발생
```

#### 경고 조건
1. **현재 DLI < 시간대별 목표의 70%**
2. **예상 총 DLI < 목표의 80%** (목표 달성 불가능)

#### 경고 메시지 개선
- 현재 DLI 값
- 예상 총 DLI 값
- 목표 대비 달성률 (%)
- 부족량 (mol/m²/day)
- 남은 시간 정보

### 3. LED 제어 로직 개선

#### 시간대 확장
```python
# 기존
if LED_ON_HOUR (8시) <= current_hour < LED_OFF_HOUR (20시):

# 개선
if active_light_start (6시) <= current_hour < active_light_end (20시):
```

#### 다단계 LED 작동 조건

**1순위: 자연광 즉시 부족**
- 조건: `curr_lux < 500 Lux`
- 동작: 즉시 LED 켜기
- 이유: 자연광이 거의 없으면 즉시 보조 필요

**2순위: 시간대별 DLI 부족**
- 조건: `현재 DLI < 시간대별 목표 DLI의 70%`
- 동작: LED 켜기
- 이유: 시간대 대비 DLI가 부족하면 보조 필요

**3순위: 예상 총 DLI 부족**
- 조건: `예상 총 DLI < 목표의 80%`
- 동작: LED 켜기
- 이유: 하루 종료 시점 목표 달성 불가능 예상

#### LED 제어 전략

**화이트 LED (주 조명)**
- 자연광 부족 시 즉시 작동
- DLI 목표 달성을 위한 보조 조명
- 페이드 인/아웃으로 광충격 방지

**보라색 LED (보조 조명)**
- DLI가 목표의 70% 미만일 때만 작동
- 화이트 LED와 동시에 켜기/끄기
- 식물 생장 최적화를 위한 스펙트럼 보완

### 4. LED 작동 시나리오 분석

#### 시나리오 1: 여름 정오 (12시)
- **자연광**: 충분 (2000+ Lux)
- **현재 DLI**: 8.0 mol/m²/day (목표의 약 67%)
- **예상 총 DLI**: 16.0 mol/m²/day (목표 달성 가능)
- **LED 동작**: 꺼짐 (자연광 충분)

#### 시나리오 2: 겨울 아침 (7시)
- **자연광**: 부족 (200 Lux)
- **현재 DLI**: 0.5 mol/m²/day (목표의 약 4%)
- **시간대별 목표**: 1.7 mol/m²/day (목표의 약 14%)
- **예상 총 DLI**: 8.0 mol/m²/day (목표 미달)
- **LED 동작**: 켜짐 (자연광 부족 + 예상 DLI 부족)

#### 시나리오 3: 겨울 오후 (15시)
- **자연광**: 보통 (800 Lux)
- **현재 DLI**: 6.0 mol/m²/day (목표의 약 50%)
- **시간대별 목표**: 9.6 mol/m²/day (목표의 약 80%)
- **예상 총 DLI**: 10.5 mol/m²/day (목표 미달)
- **LED 동작**: 켜짐 (시간대별 목표 부족)

#### 시나리오 4: 여름 저녁 (19시)
- **자연광**: 약함 (300 Lux)
- **현재 DLI**: 14.0 mol/m²/day (목표의 약 117%)
- **예상 총 DLI**: 14.5 mol/m²/day (목표 달성)
- **LED 동작**: 꺼짐 (목표 달성 완료)

---

## 📊 기술적 구현 세부사항

### 1. analyzer.py 개선

#### 추가된 함수
- `calculate_expected_dli_by_time()`: 시간대별 DLI 예측

#### 개선된 분석 로직
- 시간대별 목표 DLI 계산
- 예상 총 DLI 계산
- 목표 달성 가능 여부 판단

### 2. automation.py 개선

#### LED 제어 시간대 확장
- `active_light_start = 6` (기존 8시에서 확장)
- `active_light_end = 20` (유지)

#### 다단계 LED 작동 조건
1. 자연광 즉시 부족 체크
2. 시간대별 DLI 부족 체크
3. 예상 총 DLI 부족 체크

### 3. 웹 UI 개선 (향후)

#### DLI 진행률 표시
- 현재 DLI / 목표 DLI
- 시간대별 진행률 바
- 예상 총 DLI 표시
- 목표 달성 가능 여부 표시

---

## 🎯 예상 효과

### 1. 경고 정확도 향상
- 아침 시간대 불필요한 경고 제거
- 실제 문제 상황만 경고 표시
- 시간대 고려한 정확한 판단

### 2. LED 효율성 향상
- 겨울철 자연광 부족 시 적절한 LED 작동
- 불필요한 LED 작동 감소 (에너지 절약)
- 계절 변화에 자동 대응

### 3. 사용자 경험 개선
- 직관적인 DLI 상태 표시
- 예상 총 DLI로 안심감 제공
- 시간대별 진행 상황 파악 용이

---

## 🔧 향후 개선 가능 사항

### 1. 계절별 조정
- 일출/일몰 시간 자동 계산
- 계절별 LED 작동 시간 동적 조정
- 위도 기반 일조량 예측

### 2. 날씨 예측 연동
- 기상청 API 연동
- 흐린 날 예상 DLI 조정
- LED 사전 작동

### 3. 학습 기반 최적화
- 과거 데이터 기반 DLI 패턴 학습
- 계절별 평균 DLI 추정
- LED 작동 시간 자동 최적화

---

## 📝 참고 사항

### DLI 목표값
- **딸기**: 12-17 mol/m²/day
- **상추**: 12-16 mol/m²/day
- **현재 설정**: 12.0 mol/m²/day (최소 목표)

### 광합성 활성 시간대
- **시작**: 오전 6시
- **종료**: 오후 8시
- **총 시간**: 14시간

### LED 작동 조건 요약
1. 자연광 < 500 Lux → 즉시 LED 켜기
2. 현재 DLI < 시간대별 목표의 70% → LED 켜기
3. 예상 총 DLI < 목표의 80% → LED 켜기

---

## ✅ 완료된 작업

- [x] 시간대별 DLI 예측 알고리즘 구현
- [x] 일조량 부족 경고 로직 개선
- [x] LED 제어 시간대 확장 (6시 ~ 20시)
- [x] 다단계 LED 작동 조건 구현
- [x] 예상 총 DLI 계산 및 표시
- [x] 시간대별 목표 DLI 비율 계산

---

**작성 완료일**: 2026-01-03  
**다음 검토 예정일**: 실제 운영 데이터 수집 후 알고리즘 정확도 검증

