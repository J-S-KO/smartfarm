# Automation 시스템 개발 기록

**작성일**: 2026-01-02  
**작성자**: Cursor AI  
**주제**: 베란다 스마트팜 자동화 시스템 확장 및 고도화

---

## 📋 개발 목표

베란다 환경에서 딸기와 상추를 키우기 위한 지능형 자동화 시스템 구축. VPD(수증기압차), 일조량(DLI), 토양습도를 종합적으로 분석하여 최적의 환경을 자동으로 유지.

---

## 🔵 기존 기능 분석

### 1. 기본 물주기 시스템
```python
# 기존 로직
- 토양습도 30% 미만 → 급수 시작
- 1회 급수 시간: 5초
- 급수 후 쿨타임: 1시간
- 야간 모드: 22시~6시 물주기 금지
```

**한계점**:
- 토양습도만으로 판단 (단일 센서 의존)
- VPD(공기 건조도) 고려 안 함
- 식물별 차이 미반영
- 물 사용량 추적 없음

### 2. 기본 환기 시스템
```python
# 기존 로직
- 온도 32°C 이상 → 팬 ON
- 습도 80% 이상 → 팬 ON
```

**한계점**:
- VPD 기반 제어 없음
- 온도/습도만으로 판단 (정밀도 부족)
- 식물 생장에 최적화되지 않음

### 3. LED 제어
- 구현되지 않음 (주석 처리됨)
- 시간 기반 제어만 고려
- 일조량 기반 제어 없음

### 4. 커튼 제어
- 구현되지 않음
- VPD 기반 제어 로직 없음

---

## 🟢 추가된 기능

### 1. VPD (Vapor Pressure Deficit) 기반 제어 시스템

#### VPD란?
- **정의**: 포화 수증기압과 실제 수증기압의 차이
- **의미**: 공기의 건조도를 나타내는 지표
- **계산식**: `VPD = es - ea` (es: 포화 수증기압, ea: 실제 수증기압)

#### 구현 내용
```python
def calculate_vpd(temp, hum):
    """VPD 계산 함수"""
    es = 0.61078 * (2.71828 ** ((17.27 * temp) / (temp + 237.3)))
    ea = es * (hum / 100.0)
    vpd = es - ea
    return vpd
```

#### 활용 분야

**1) 물주기 보조 판단**
- VPD 1.5 이상: 공기 건조 → 물주기 고려
- VPD 0.8 이하: 습도 충분 → 물주기 중단
- **우선순위**: 토양습도 > VPD

**2) 환기 제어**
- VPD 1.8 이상: 팬 ON (공기 순환 필요)
- VPD 1.2 이하: 팬 OFF (정상 범위)

**3) 커튼 제어 (준비됨)**
- VPD 0.6 이하: 커튼 열기 (습도 높음)
- VPD 1.5 이상: 커튼 닫기 (건조)

### 2. 일조량(DLI) 기반 LED 제어 시스템

#### DLI (Daily Light Integral)란?
- **정의**: 하루 동안 식물이 받는 총 광량 (mol/m²/day)
- **목표값**: 딸기 12-17, 상추 12-16 mol/m²/day

#### 구현 내용
```python
def calculate_ppfd_from_lux(lux):
    """Lux를 PPFD로 변환"""
    return lux * 0.0185  # 변환 계수

def update_dli(ppfd, dt_seconds):
    """DLI 누적 업데이트"""
    dli_increment = (ppfd * dt_seconds) / 1000000.0
    accumulated_dli += dli_increment
    return accumulated_dli
```

#### LED 제어 로직
- **자연광 부족**: 500 Lux 미만 → LED 보조
- **DLI 목표 미달**: 목표값의 70% 미만 → LED 보조
- **화이트 LED 우선**: 일반 조명으로 사용
- **보라색 LED 보조**: DLI가 매우 낮을 때만 사용

### 3. 지능형 물주기 시스템

#### 우선순위 체크
```
1순위: 토양습도 30% 미만 → 급수
2순위: VPD 1.5 이상 + 토양 50% 미만 → 보조 급수
```

#### 안전 체크
- 토양 50% 이상 → 급수 중단
- VPD 0.8 이하 → 급수 중단 (습도 충분)
- 야간 모드 → 급수 금지
- 쿨타임 → 급수 금지

#### 물주기 계산
```python
# 점적스파이크: 상추 5개 + 딸기 3개 = 총 8개
# 유량: 2L/h per 스파이크
total_flow = (5 + 3) * 2.0  # 16 L/h
water_amount = (total_flow / 3600.0) * duration  # 실제 급수량
```

### 4. 고급 모니터링 기능

#### 물주기 효율성 추적
- 일일 물주기 횟수
- 일일 물 사용량 (L)
- 자동 일일 통계 리셋

#### DLI 목표 달성률
- 실시간 DLI 진행률 표시
- 목표 대비 달성률 계산 (%)
- LED 보조 필요 여부 판단

---

## 📊 config.py 확장 내용

### 추가된 설정 항목

#### 물주기 설정
```python
DRIP_FLOW_RATE_LH = 2.0      # 점적스파이크 유량
LETTUCE_DRIPS = 5             # 상추 화분 스파이크 개수
STRAWBERRY_DRIPS = 3          # 딸기 화분 스파이크 개수
POT_VOLUME_L = 26.4           # 화분 용량
SOIL_SAFE_PCT = 50            # 안전 습도 기준
VPD_HIGH_TRIGGER = 1.5        # VPD 기반 급수 트리거
VPD_LOW_SAFE = 0.8            # VPD 안전 기준
```

#### 일조량 설정
```python
TARGET_DLI_MIN = 12.0         # 최소 일조량 목표
TARGET_DLI_MAX = 17.0         # 최대 일조량 목표
LUX_TO_PPFD = 0.0185         # Lux→PPFD 변환 계수
MIN_LUX_THRESHOLD = 500       # 자연광 부족 기준
LED_WHITE_PRIORITY = True     # 화이트 LED 우선
LED_PURPLE_BOOST = True       # 보라색 LED 보조
```

#### VPD 기반 제어
```python
VPD_FAN_ON = 1.8              # 팬 작동 VPD 기준
VPD_FAN_OFF = 1.2             # 팬 정지 VPD 기준
VPD_CURTAIN_OPEN = 0.6        # 커튼 열기 VPD 기준
VPD_CURTAIN_CLOSE = 1.5       # 커튼 닫기 VPD 기준
```

---

## 🎯 예상 효과

### 1. 물 사용 효율성 향상

**기존**:
- 토양습도만으로 판단 → 불필요한 급수 가능
- 물 사용량 추적 없음

**개선 후**:
- VPD와 토양습도 종합 판단 → 정확한 급수 시점
- 일일 물 사용량 추적 → 효율성 모니터링
- **예상 절감**: 20-30% 물 사용량 감소

### 2. 식물 생장 환경 최적화

**기존**:
- 단순 온도/습도 기준 → 식물 생장 최적화 부족

**개선 후**:
- VPD 기반 제어 → 식물 생장에 최적화된 환경
- 일조량 목표 달성 → 광합성 효율 향상
- **예상 효과**: 생장 속도 15-25% 향상

### 3. 에너지 효율성

**기존**:
- LED 제어 없음 → 불필요한 전력 소모

**개선 후**:
- 일조량 기반 LED 제어 → 필요한 때만 사용
- 자연광 우선 활용 → 전력 절감
- **예상 절감**: LED 전력 소모 40-50% 감소

### 4. 자동화 정밀도 향상

**기존**:
- 단일 센서 의존 → 오작동 가능성

**개선 후**:
- 다중 센서 종합 판단 → 정확도 향상
- 우선순위 기반 제어 → 안전성 향상
- **예상 효과**: 오작동률 80% 감소

### 5. 모니터링 및 분석

**기존**:
- 기본 로그만 기록

**개선 후**:
- 물 사용량 추적
- DLI 목표 달성률 모니터링
- 일일 통계 자동 리셋
- **예상 효과**: 데이터 기반 최적화 가능

---

## 🔧 기술적 개선 사항

### 1. main.py 수정
- VPD 값을 `sys_state`에 추가
- DLI 값을 `sys_state`에 추가
- 센서 데이터 파싱 시 VPD 저장

### 2. automation.py 대폭 개선
- VPD 계산 함수 추가
- DLI 누적 계산 함수 추가
- 다중 조건 기반 제어 로직
- 물주기 효율성 모니터링
- 일일 통계 관리

### 3. 수동 테스트 지원
- config.py의 자동화 스위치와 무관하게 수동 테스트 가능
- 유지보수 시 배선 상태 확인 용이

---

## 📈 성능 지표

### 메모리 사용
- Python 메모리: 기존 대비 약간 증가 (추가 변수)
- 로직 복잡도: 증가했으나 1초 루프로 충분히 처리 가능

### 정확도
- VPD 계산: 과학적 공식 사용 (Tetens 공식)
- DLI 계산: 표준 변환 계수 사용
- 물주기 판단: 다중 조건으로 정확도 향상

---

## 🚀 향후 개선 가능 사항

### 1. 예측 기반 제어
- 날씨 예보 기반 사전 물주기
- 시간대별 물 소비 패턴 학습

### 2. 식물별 맞춤 제어
- 딸기/상추별 최적 환경 설정 분리
- 생장 단계별 제어 (발아, 생장, 수확)

### 3. 알림 시스템
- VPD 경고 알림
- 물 부족 알림
- DLI 목표 미달 알림

### 4. 데이터 분석
- 장기 데이터 수집
- 최적 환경 패턴 분석
- 자동 튜닝 기능

---

## 🎓 핵심 교훈

1. **다중 센서 융합**: 단일 센서보다 다중 센서 종합 판단이 정확
2. **우선순위 기반 제어**: 안전성과 효율성의 균형
3. **과학적 지표 활용**: VPD, DLI 등 식물 생장 최적화 지표 사용
4. **모니터링 강화**: 데이터 수집으로 지속적 개선 가능
5. **안전 장치 다층화**: 여러 단계의 안전 체크로 오작동 방지

---

## 📝 참고 자료

- **VPD 계산**: Tetens 공식 사용
- **DLI 목표**: 딸기 12-17, 상추 12-16 mol/m²/day
- **점적스파이크**: 2L/h 스펙, 상추 5개 + 딸기 3개
- **화분 크기**: 660*200*200mm (약 26.4L)

