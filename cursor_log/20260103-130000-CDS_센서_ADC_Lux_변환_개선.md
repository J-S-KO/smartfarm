# CDS 센서 ADC → Lux 변환 개선 기록

**작성일**: 2026-01-03  
**작성자**: Cursor AI  
**주제**: CDS 센서 ADC 값을 실제 Lux 값으로 변환하는 지수함수 피팅 및 적용

---

## 📋 개선 목적

기존에는 CDS 센서의 ADC raw 값을 그대로 Lux로 사용하고 있었으나, 실제 측정값과 차이가 발생했습니다. 사용자가 측정한 실제 데이터를 바탕으로 지수함수 피팅을 수행하여 정확한 Lux 변환 공식을 도출하고 적용했습니다.

---

## 📊 측정 데이터

사용자가 CDS 센서 ADC 값과 실제 Lux 값을 측정한 데이터:

| ADC (입력) | Lux (실제값) | 상태 분석 |
|-----------|-------------|----------|
| 220 | 125 | 약간 의외의 값 (보통 이 정도 ADC면 더 어두워야 함) |
| 450 | 180 | 실내 적정 조도 시작 |
| 480 | 500 | 밝아지기 시작 |
| 563 | 980 | 흐린 날 / 간접광 |
| 589 | 1570 | 급격한 상승 구간 (Growth Zone) |
| 590 | 1280 | (589와 유사, 측정 오차 범위) |
| 610 | 2550 | 식물 성장용 강한 빛 |

**센서 설정 변경**: 10K 저항 4개를 병렬로 연결하여 2.5K로 변경

---

## 🔬 지수함수 피팅 결과

### 모델 비교

#### 1. 지수함수 모델: `Lux = a * exp(b * ADC)`
- **계수 a**: `1.582191e+01`
- **계수 b**: `0.007467`
- **R²**: `0.7189`

#### 2. 거듭제곱 모델: `Lux = a * ADC^b`
- **계수 a**: `4.638599e-05`
- **계수 b**: `2.670799`
- **R²**: `0.5570`

### 선택된 모델

**지수함수 모델**이 더 정확한 것으로 판단되어 선택했습니다 (R² = 0.7189).

**최종 공식**:
```
Lux = 1.582191e+01 * exp(0.007467 * ADC)
```

### 예측값 비교

| ADC | 실제 Lux | 지수함수 예측 | 오차 |
|-----|---------|--------------|------|
| 220 | 125 | 81.8 | 43.2 |
| 450 | 180 | 455.7 | 275.7 |
| 480 | 500 | 570.1 | 70.1 |
| 563 | 980 | 1059.5 | 79.5 |
| 589 | 1570 | 1286.5 | 283.5 |
| 590 | 1280 | 1296.2 | 16.2 |
| 610 | 2550 | 1505.0 | 1045.0 |

> **참고**: 610에서 오차가 큰 것은 측정 데이터의 급격한 변화 때문일 수 있습니다. 대부분의 범위에서는 합리적인 예측을 보입니다.

---

## 🔧 구현 내용

### 1. config.py에 계수 추가

```python
# CDS 센서 ADC -> Lux 변환 (지수함수 피팅)
# 측정 데이터 기반: Lux = a * exp(b * ADC)
# 저항: 10K 4개 병렬 = 2.5K
CDS_ADC_TO_LUX_A = 1.582191e+01  # 지수함수 계수 a
CDS_ADC_TO_LUX_B = 0.007467      # 지수함수 계수 b
```

### 2. automation.py에 변환 함수 추가

```python
def adc_to_lux(adc_value):
    """
    CDS 센서 ADC 값을 Lux로 변환
    지수함수 피팅: Lux = a * exp(b * ADC)
    Args:
        adc_value: ADC raw 값 (0-1023)
    Returns:
        Lux 값
    """
    import math
    if adc_value <= 0:
        return 0.0
    return config.CDS_ADC_TO_LUX_A * math.exp(config.CDS_ADC_TO_LUX_B * adc_value)
```

### 3. main.py에서 ADC → Lux 변환 적용

- 센서 데이터 수신 시 ADC 값을 Lux로 변환
- 변환된 Lux 값을 `sys_state['lux']`에 저장
- 로그 기록 시에도 변환된 Lux 값 사용
- 변환 실패 시 하위 호환성을 위해 ADC 값을 그대로 사용

---

## 📈 영향 범위

### 자동으로 반영되는 값들

1. **Lux 값**: 모든 시스템에서 변환된 Lux 값 사용
2. **PPFD**: `PPFD = Lux * 0.0185` (자동 계산)
3. **DLI**: `DLI = 누적(PPFD * 시간)` (자동 계산)
4. **LED 제어**: 변환된 Lux 값 기반으로 작동
5. **로그 기록**: 변환된 Lux 값이 CSV에 기록됨
6. **웹 대시보드**: 변환된 Lux 값이 표시됨

---

## ✅ 테스트 결과

변환 함수 테스트:
```python
ADC 220 -> Lux: 81.8
ADC 450 -> Lux: 455.6
ADC 610 -> Lux: 1505.0
```

---

## 🔄 향후 개선 가능 사항

1. **추가 측정 데이터 수집**: 더 많은 데이터 포인트로 피팅 정확도 향상
2. **온도 보정**: CDS 센서는 온도에 민감하므로 온도 보정 고려
3. **비선형 보정**: 특정 범위에서 더 정확한 보정 곡선 적용
4. **자동 캘리브레이션**: 주기적으로 실제 조도와 비교하여 계수 자동 조정

---

## 📝 참고 사항

- **저항 변경**: 10K → 2.5K (4개 병렬)
- **측정 도구**: 핸드폰 조도 센서
- **측정 환경**: 다양한 조도 조건 (실내, 간접광, 강한 빛)
- **오차 요인**: 측정 시점, 환경 조건, 센서 특성 등

---

**작성 완료일**: 2026-01-03

